name: Deploy to Cloudflare

# âš ï¸ å·²å®Œå…¨ç¦ç”¨ - åªä½¿ç”¨ GitHub Pages éƒ¨ç½²
# å¦‚éœ€ä½¿ç”¨ Cloudflareï¼Œè¯·ï¼š
# 1. è®¾ç½® CLOUDFLARE_API_TOKEN å’Œ CLOUDFLARE_ACCOUNT_ID secrets
# 2. å–æ¶ˆä¸‹é¢çš„æ³¨é‡Šå¹¶ä¿å­˜
# 3. æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm Cloudflare deployment'
        required: true
        default: ''

# å®Œå…¨ç¦ç”¨ï¼Œé™¤éæ˜ç¡®è®¾ç½®äº† token
jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ secrets.CLOUDFLARE_API_TOKEN != '' && github.event.inputs.confirm == 'deploy' }}
    steps:
      - name: Check Cloudflare Token
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ]; then
            echo "âŒ CLOUDFLARE_API_TOKEN not set. Skipping Cloudflare deployment."
            echo "ğŸ’¡ Use GitHub Pages deployment instead: deploy-gh-pages.yml"
            exit 1
          fi
      
      - uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL || 'https://cancri-api.xinhalle356.workers.dev' }}
          BASE_PATH: /cancri/
          CI: true
          NODE_ENV: production
      
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: cancri
          directory: dist
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Deploy Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: worker
  
  skip:
    runs-on: ubuntu-latest
    if: ${{ secrets.CLOUDFLARE_API_TOKEN == '' || github.event.inputs.confirm != 'deploy' }}
    steps:
      - name: Skip Cloudflare Deployment
        run: |
          echo "â­ï¸  Skipping Cloudflare deployment"
          echo "ğŸ’¡ This workflow requires CLOUDFLARE_API_TOKEN secret"
          echo "ğŸ’¡ Use GitHub Pages deployment instead: deploy-gh-pages.yml"
          echo "âœ… GitHub Pages deployment is active and working"



